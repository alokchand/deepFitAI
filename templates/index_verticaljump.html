<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepFit - Vertical Jump Analyzer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='situp-modern.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/exercise-common.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/exercise-header.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <meta name="theme-color" content="#000000">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
</head>
<body>
    <div class="container">
        <header class="app-header">
            <div class="header-content">
                <div class="header-title">
                    <h1 style="color: #06b6d4;"><span class="header-icon">üèÉ</span> Vertical Jump Analyzer</h1>
                    <p>Your AI-powered personal trainer for perfect vertical jumps</p>
                </div>
                <a href="/" class="btn btn-secondary btn-back">
                    <i class="fas fa-arrow-left"></i>
                    <span class="btn-text">Back to Home</span>
                </a>
            </div>
        </header>

        <div class="main-content">
            <div class="video-section">
                <div class="video-container">
                    <img id="video-feed" src="" alt="Camera feed will appear here" style="display: none;" 
                         onerror="this.style.display='none'; document.getElementById('placeholder').style.display='flex';">
                    <div id="placeholder" class="video-placeholder">
                        <div class="placeholder-content">
                            <h3>üìπ Camera Ready</h3>
                            <p>Click "Start Camera" to begin your vertical jump session</p>
                        </div>
                    </div>
                </div>
                
                <div class="controls">
                    <button id="start-btn" class="btn btn-primary">Start Camera</button>
                    <button id="stop-btn" class="btn btn-secondary" disabled>Stop Camera</button>
                    <button id="reset-btn" class="btn btn-warning">Reset Counter</button>
                    <button id="submit-btn" class="btn btn-success">Submit</button>
                </div>
            </div>

            <div class="stats-section">
                <div class="timer-card" style="background:#071730; border:1px solid rgba(255,255,255,0.04); box-shadow:0 6px 18px rgba(2,6,23,0.45); color:#e6eef9;">
                    <h3>‚è±Ô∏è Timer</h3>
                    <div class="timer-display">
                        <div class="time-remaining" id="timer-display">6:00</div>
                        <div class="timer-label">Time Remaining</div>
                        <div class="timer-progress">
                            <div class="timer-progress-bar">
                                <div class="timer-progress-fill" id="timer-progress"></div>
                            </div>
                        </div>
                        <div class="session-status" id="session-status">Ready to start</div>
                    </div>
                </div>

                <div class="stats-card" style="background:#071730; border:1px solid rgba(255,255,255,0.04); box-shadow:0 6px 18px rgba(2,6,23,0.45); color:#e6eef9;">
                    <h3>üìä Jump Stats</h3>
                    
                    <div class="stat-item">
                        <div class="stat-label">Total Jumps</div>
                        <div class="stat-value" id="jumps-count">0</div>
                    </div>
                    
                    <div class="stat-item">
                        <div class="stat-label">Current Height</div>
                        <div class="stat-value" id="current-height">0.0cm</div>
                    </div>

                    <div class="stat-item">
                        <div class="stat-label">Max Height</div>
                        <div class="stat-value" id="max-height">0.0cm</div>
                    </div>
                    
                    <div class="stat-item">
                        <div class="stat-label">State</div>
                        <div class="feedback" id="state">GROUND</div>
                    </div>

                    <div class="stat-item">
                        <div class="stat-label">Calibrated</div>
                        <div class="feedback" id="calibrated">NO</div>
                    </div>
                    
                    <div class="stat-item">
                        <div class="stat-label">Feedback</div>
                        <div class="feedback" id="feedback">System Ready</div>
                    </div>
                </div>

                <div class="instructions-card" style="background:#071730; border:1px solid rgba(255,255,255,0.04); box-shadow:0 6px 18px rgba(2,6,23,0.45); color:#e6eef9;">
                    <h3>üìã Instructions</h3>
                    <ul>
                        <li>Stand in full view of the camera</li>
                        <li>Keep your body straight and centered</li>
                        <li>Jump as high as you can with both feet</li>
                        <li>Land softly on both feet</li>
                        <li>Wait for system calibration before jumping</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        class VerticalJumpTracker {
            constructor() {
                this.isRunning = false;
                this.statsInterval = null;
                this.timerInterval = null;
                this.timeRemaining = 360; // 6 minutes in seconds
                this.totalTime = 360;
                this.startTime = null;
                this.endTime = null;
                this.timerCompleted = false;
                this.initializeElements();
                this.bindEvents();
            }

            initializeElements() {
                this.startBtn = document.getElementById('start-btn');
                this.stopBtn = document.getElementById('stop-btn');
                this.resetBtn = document.getElementById('reset-btn');
                this.submitBtn = document.getElementById('submit-btn');
                this.videoFeed = document.getElementById('video-feed');
                this.placeholder = document.getElementById('placeholder');
                this.jumpsCount = document.getElementById('jumps-count');
                this.currentHeight = document.getElementById('current-height');
                this.maxHeight = document.getElementById('max-height');
                this.state = document.getElementById('state');
                this.calibrated = document.getElementById('calibrated');
                this.feedback = document.getElementById('feedback');
                this.timerDisplay = document.getElementById('timer-display');
                this.timerProgress = document.getElementById('timer-progress');
                this.sessionStatus = document.getElementById('session-status');
            }

            bindEvents() {
                this.startBtn.addEventListener('click', () => this.startCamera());
                this.stopBtn.addEventListener('click', () => this.stopCamera());
                this.resetBtn.addEventListener('click', () => this.resetCounter());
                this.submitBtn.addEventListener('click', () => this.submitResults());
            }

            async startCamera() {
                try {
                    this.showLoading('Starting camera...');
                    
                    const response = await fetch('/vertical_jump/start_camera?' + new Date().getTime());
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        this.isRunning = true;
                        this.videoFeed.src = '/vertical_jump/video_feed?' + new Date().getTime();
                        this.videoFeed.style.display = 'block';
                        this.placeholder.style.display = 'none';
                        
                        this.startBtn.disabled = true;
                        this.stopBtn.disabled = false;
                        
                        this.startTimer();
                        this.startStatsUpdate();
                        this.showFeedback('Camera started! Stand in view for calibration.', 'success');
                    } else {
                        this.showFeedback('Failed to start camera: ' + data.message, 'error');
                    }
                } catch (error) {
                    this.showFeedback('Error starting camera: ' + error.message, 'error');
                }
            }

            async stopCamera() {
                try {
                    await fetch('/vertical_jump/stop_camera');
                    
                    this.isRunning = false;
                    this.videoFeed.style.display = 'none';
                    this.placeholder.style.display = 'flex';
                    this.videoFeed.src = '';
                    
                    this.startBtn.disabled = false;
                    this.stopBtn.disabled = true;
                    
                    this.stopTimer();
                    this.stopStatsUpdate();
                    this.showFeedback('Camera stopped.', 'info');
                } catch (error) {
                    this.isRunning = false;
                    this.videoFeed.style.display = 'none';
                    this.placeholder.style.display = 'flex';
                    this.startBtn.disabled = false;
                    this.stopBtn.disabled = true;
                    this.stopStatsUpdate();
                }
            }

            async resetCounter() {
                try {
                    if (this.isRunning) {
                        await this.stopCamera();
                    }
                    
                    const response = await fetch('/vertical_jump/reset_counter');
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        this.isRunning = false;
                        this.videoFeed.style.display = 'none';
                        this.placeholder.style.display = 'flex';
                        this.videoFeed.src = '';
                        
                        this.startBtn.disabled = false;
                        this.stopBtn.disabled = true;
                        
                        this.stopStatsUpdate();
                        this.resetTimer();
                        
                        this.updateStats({
                            total_jumps: 0,
                            current_height: 0.0,
                            max_height: 0.0,
                            state: 'GROUND',
                            calibrated: false,
                            feedback: 'System Ready'
                        });
                        
                        this.showFeedback('Counter reset! Ready for new session.', 'success');
                    } else {
                        this.showFeedback('Error resetting: ' + data.message, 'error');
                    }
                } catch (error) {
                    this.showFeedback('Error resetting counter: ' + error.message, 'error');
                }
            }

            startStatsUpdate() {
                this.statsInterval = setInterval(async () => {
                    if (this.isRunning) {
                        try {
                            const response = await fetch('/vertical_jump/get_stats');
                            const stats = await response.json();
                            this.updateStats(stats);
                        } catch (error) {
                            console.error('Error fetching stats:', error);
                        }
                    }
                }, 500);
            }

            stopStatsUpdate() {
                if (this.statsInterval) {
                    clearInterval(this.statsInterval);
                    this.statsInterval = null;
                }
            }

            updateStats(stats) {
                this.jumpsCount.textContent = stats.total_jumps || 0;
                this.currentHeight.textContent = stats.current_height + 'cm' || '0.0cm';
                this.maxHeight.textContent = stats.max_height + 'cm' || '0.0cm';
                this.state.textContent = stats.state || 'GROUND';
                this.calibrated.textContent = stats.calibrated ? 'YES' : 'NO';
                this.feedback.textContent = stats.feedback || 'System Ready';
                
                // Update colors based on state
                this.state.style.color = stats.state === 'PEAK' ? '#4CAF50' : 
                                        stats.state === 'TAKEOFF' ? '#FF9800' : '#666';
                this.calibrated.style.color = stats.calibrated ? '#4CAF50' : '#f44336';
            }

            showLoading(message) {
                this.feedback.textContent = message;
                this.feedback.style.color = '#2196F3';
            }

            showFeedback(message, type) {
                const colors = {
                    success: '#4CAF50',
                    error: '#f44336',
                    info: '#2196F3',
                    warning: '#ff9800'
                };
                
                if (!this.isRunning || type === 'error') {
                    const originalFeedback = this.feedback.textContent;
                    
                    this.feedback.textContent = message;
                    this.feedback.style.color = colors[type] || '#666';
                    
                    setTimeout(() => {
                        if (!this.isRunning) {
                            this.feedback.textContent = 'System Ready';
                            this.feedback.style.color = '#666';
                        }
                    }, 3000);
                }
            }

            startTimer() {
                this.startTime = new Date();
                this.timeRemaining = 360;
                this.timerCompleted = false;
                this.updateTimerDisplay();
                
                this.timerInterval = setInterval(() => {
                    this.timeRemaining--;
                    this.updateTimerDisplay();
                    
                    if (this.timeRemaining <= 0) {
                        this.onTimerComplete();
                    }
                }, 1000);
                
                this.sessionStatus.textContent = 'Session in progress';
            }

            stopTimer() {
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                    this.timerInterval = null;
                }
                this.endTime = new Date();
                this.sessionStatus.textContent = 'Session paused';
            }

            resetTimer() {
                this.stopTimer();
                this.timeRemaining = 360;
                this.totalTime = 360;
                this.startTime = null;
                this.endTime = null;
                this.timerCompleted = false;
                this.updateTimerDisplay();
                this.sessionStatus.textContent = 'Ready to start';
            }

            updateTimerDisplay() {
                const minutes = Math.floor(this.timeRemaining / 60);
                const seconds = this.timeRemaining % 60;
                this.timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                const progress = ((this.totalTime - this.timeRemaining) / this.totalTime) * 100;
                this.timerProgress.style.width = progress + '%';
                
                if (this.timeRemaining <= 30) {
                    this.timerDisplay.style.color = '#f44336';
                } else if (this.timeRemaining <= 60) {
                    this.timerDisplay.style.color = '#ff9800';
                } else {
                    this.timerDisplay.style.color = '#00d4ff';
                }
            }

            onTimerComplete() {
                this.stopTimer();
                this.timerCompleted = true;
                this.timerDisplay.textContent = '0:00';
                this.timerProgress.style.width = '100%';
                this.sessionStatus.textContent = 'Time completed!';
                
                this.showTimeCompletedPopup();
            }

            showTimeCompletedPopup() {
                const popup = document.createElement('div');
                popup.className = 'popup-overlay';
                popup.innerHTML = `
                    <div class="popup-content">
                        <div class="popup-icon">‚è∞</div>
                        <h3>Time Completed!</h3>
                        <p>Your 3-minute vertical jump session is complete. Please click Submit to save your results.</p>
                        <button onclick="this.parentElement.parentElement.remove()" class="btn btn-primary">OK</button>
                    </div>
                `;
                document.body.appendChild(popup);
            }

            async submitResults() {
                try {
                    const jumps = parseInt(this.jumpsCount.textContent) || 0;
                    const maxHeight = parseFloat(this.maxHeight.textContent.replace('cm', '')) || 0;
                    
                    let timerTime;
                    if (this.timerCompleted) {
                        timerTime = '6:00';
                    } else if (this.startTime && this.endTime) {
                        const duration = Math.floor((this.endTime - this.startTime) / 1000);
                        const minutes = Math.floor(duration / 60);
                        const seconds = duration % 60;
                        timerTime = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    } else {
                        const elapsed = this.totalTime - this.timeRemaining;
                        const minutes = Math.floor(elapsed / 60);
                        const seconds = elapsed % 60;
                        timerTime = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    }
                    
                    // Submit to backend
                    const submitResponse = await fetch('/api/submit_vertical_jump_result', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            total_jumps: jumps,
                            max_height: maxHeight,
                            timer_time: timerTime
                        })
                    });
                    
                    const submitData = await submitResponse.json();
                    
                    if (submitData.success) {
                        await this.resetCounter();
                        window.location.href = `/displayVerticalJump?jumps=${jumps}&max_height=${maxHeight}&timer=${timerTime}`;
                    } else {
                        this.showFeedback('Error submitting results: ' + submitData.message, 'error');
                    }
                } catch (error) {
                    this.showFeedback('Error submitting results: ' + error.message, 'error');
                }
            }
        }

        // Initialize the vertical jump tracker when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new VerticalJumpTracker();
        });

        // Handle page visibility changes and cleanup
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                console.log('Page hidden - pausing camera');
            } else {
                console.log('Page visible');
            }
        });

        // Cleanup when page is about to be unloaded
        window.addEventListener('beforeunload', async () => {
            try {
                await fetch('/vertical_jump/cleanup', { method: 'POST' });
            } catch (error) {
                console.log('Cleanup error:', error);
            }
        });

        // Handle page refresh/close
        window.addEventListener('unload', () => {
            navigator.sendBeacon('/vertical_jump/cleanup');
        });

        // Add popup styles
        const style = document.createElement('style');
        style.textContent = `
            .popup-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            }
            .popup-content {
                background: linear-gradient(135deg, rgba(0, 0, 0, 0.9), rgba(0, 170, 255, 0.1));
                padding: 30px;
                border-radius: 15px;
                text-align: center;
                max-width: 400px;
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }
            .popup-icon {
                font-size: 3rem;
                margin-bottom: 20px;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>